(function(a,b){"function"==typeof define&&define.amd?define(["underscore","jquery","exports"],function(c,d,e){a.Chitin=b(a,e,c,d)}):a.Chitin=b(a,{},a._,a.jQuery||a.Zepto)})(this,function(a,b,c,d){"use strict";var e=a.Chitin;b.noConflict=function(){return a.Chitin=e,this};var f=function(a,b){var e,d=this;e=a&&c.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},c.extend(e,d,b);var f=function(){this.constructor=e};return f.prototype=d.prototype,e.prototype=new f,a&&c.extend(e.prototype,a),e.__super__=d.prototype,e},g=/\s+/,h=[].slice,i=/^(\S+)\s*(.*)$/,j=function(a,b,c,d){if(!c)return!0;if("object"==typeof c)for(var e in c)a[b].apply(a,[e,c[e]].concat(d));else{if(!g.test(c))return!0;for(var f=c.split(g),h=0,i=f.length;i>h;h++)a[b].apply(a,[f[h]].concat(d))}},k=function(a,b){var c,d=-1,e=a.length;switch(b.length){case 0:for(;e>++d;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;e>++d;)(c=a[d]).callback.call(c.ctx,b[0]);return;case 2:for(;e>++d;)(c=a[d]).callback.call(c.ctx,b[0],b[1]);return;case 3:for(;e>++d;)(c=a[d]).callback.call(c.ctx,b[0],b[1],b[2]);return;default:for(;e>++d;)(c=a[d]).callback.apply(c.ctx,b)}},l={on:function(a,b,c){if(!j(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,d){if(!j(this,"once",a,[b,d])||!b)return this;var e=this,f=c.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,d),this},off:function(a,b,d){var e,f,g,h,i,k,l,m;if(!this._events||!j(this,"off",a,[b,d]))return this;if(!a&&!b&&!d)return this._events={},this;for(h=a?[a]:c.keys(this._events),i=0,k=h.length;k>i;i++)if(a=h[i],e=this._events[a]){if(g=[],b||d)for(l=0,m=e.length;m>l;l++)f=e[l],(b&&b!==f.callback&&b!==f.callback._callback||d&&d!==f.context)&&g.push(f);this._events[a]=g}return this},trigger:function(a){if(!this._events)return this;var b=h.call(arguments,1);if(!j(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&k(c,b),d&&k(d,arguments),this},listenTo:function(a,b,d){var e=this._listeners||(this._listeners={}),f=a._listenerId||(a._listenerId=c.uniqueId("l"));return e[f]=a,a.on(b,"object"==typeof b?this:d,this),this},stopListening:function(a,b,c){var d=this._listeners;if(d){if(a)a.off(b,"object"==typeof b?this:c,this),b||c||delete d[a._listenerId];else{"object"==typeof b&&(c=this);for(var e in d)d[e].off(b,c,this);this._listeners={}}return this}}},m=b.Abstract=function(a){this.initialize(a)};m.prototype={initialize:function(a){this.params=c.extend({},this.defaults||{},a||{})}},m.extend=f;var n=b.Observable=m.extend();c.extend(n.prototype,l);var o=b.Widget=n.extend({$:function(a){return this.$el.find(a)},_getTplNode:function(a){return d("script.js-tpl-"+a)},getTemplate:function(){var a=c.result(this,"tpl");if(!a)throw Error("No tpl property defined");var b=this._getTplNode(a);if(1!==b.length)throw Error('Invalid tpl selector: "'+a+'" â€” no such nodes or too many.');return c.template(b.html())},render:function(a){this.$el.html(this.template(a)),this.onRender()},onRender:function(){this.delegateEvents(),this._ensureUI()},_delegateEvents:function(a){var b=this.$el;this._undelegateEvents();for(var d in a){var e=a[d];if(c.isFunction(e)||(e=this[a[d]]),!e)throw Error('Method "'+a[d]+'" does not exist');var f=d.match(i),g=f[1],h=f[2];e=c.bind(e,this),g+=".delegateEvents"+this.cid,""===h?b.on(g,e):b.on(g,h,e)}},_undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid)},delegateEvents:function(a){(a||(a=c.result(this,"events")))&&this._delegateEvents(a)},delegateBusEvents:function(a){this.stopListening(this.bus),(a||(a=c.result(this,"busEvents")))&&c.each(a,function(a,b){var d;if(c.isFunction(a))d=a;else{if(!c.isString(a)||!this[a])throw Error('Method "'+a+'" does not exist or invalid');d=this[a]}this.listenTo(this.bus,b,d)},this)},ensureSubWidgets:function(a){if(a||(a=c.result(this,"subWidgets"))){var b,d;c.each(a,function(a,e){c.isArray(a)?(b=a[0],d={},c.isFunction(a[1])?d=a[1].call(this):c.isString(a[1])&&(d=this[a[1]])):(b=a,d={}),this.registerChild(e,b,d)},this)}},_ensureUI:function(a){a||(a=c.result(this,"_ui")),a&&(this.ui={},c.each(a,function(a,b){this.ui[b]=this.$(a)},this))},registerChild:function(a,b,d){this.children[a]=new b(c.extend({el:this.$(a),bus:this.bus},d))},unregisterChild:function(a){var b=this.children[a];b&&(b.destroy(),delete this.children[a])},initialize:function(a){o.__super__.initialize.call(this,a),this.cid=c.uniqueId("widget"),this.$el=d(a.el),this.template=this.getTemplate(),this.bus=this.params.bus,this.delegateEvents(),this.delegateBusEvents(),this.children={}},destroy:function(){this._undelegateEvents(),this.off(),this.stopListening(),c.each(this.children,function(a,b){this.unregisterChild(b)},this),this.$el.html("")}}),p=b.Application=n.extend({defaults:{immediateStart:!0,rootWidget:o,rootNode:"html"},initialize:function(a){p.__super__.initialize.call(this,a),this.params.immediateStart&&this.start()},start:function(){return this.root=new this.params.rootWidget({bus:this,el:this.params.rootNode}),this}});return b});